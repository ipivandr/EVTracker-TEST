<!DOCTYPE html> 
<html lang="ru"> 
    <head> 
        <meta charset="UTF-8">  
        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"> 
        <title>EVTracker</title> 
            <link rel="manifest" href="manifest.json">
            <meta name="apple-mobile-web-app-capable" content="yes">
            <meta name="apple-mobile-web-app-status-bar-style" content="black">
            <meta name="apple-mobile-web-app-title" content="EV Tracker">
            <link rel="apple-touch-icon" href="apple-touch-icon.png">
            <meta name="theme-color" content="#000000">
            <script>
                if("serviceWorker" in navigator) {
                    navigator.serviceWorker.register("service-worker.js");
                }
            </script>

        <style> 

            html {
                touch-action: none;}

            body, .wrapper, .app {
                touch-action: manipulation;}

            html, body {
                overflow: hidden;
                height: 100%;}

            body { 
                margin: 0; 
                padding: 0;
                height: 100%; 
                background: #000000; 
                color: white; 
                font-family: -apple-system, BlinkMacSystemFont, sans-serif; 
                display: flex; 
                justify-content: center; 
                align-items: center; } 

            .wrapper {
                height: 100vh;
                padding: 
                    env(safe-area-inset-top)
                    env(safe-area-inset-right)
                    env(safe-area-inset-bottom)
                    env(safe-area-inset-left);
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center; }

            .app { 
                width: 100%; 
                max-width: 420px; 
                min-height: auto; 
                padding: 20px; 
                box-sizing: border-box; 
                display: flex; 
                flex-direction: column; 
                align-items: center; 
                justify-content: space-between; } 

            .start-btn { 
                width: 90%; 
                padding: 18px; 
                font-size: 20px; 
                font-weight: 700; 
                border-radius: 30px; 
                border: none; } 
                
            .start { 
                background: #2ecc71; 
                color: black; } 

            .stop { 
                background: #e74c3c; 
                color: white; } 

            .status-row {
                display: flex;
                justify-content: space-between;
                width: 90%;
                margin-top: 20px;}

            .status-btn {
                width: 100px;
                height: 65px;
                border-radius: 35px;
                border: none;
                background: #555;
                color: white;
                font-size: 36px;
                display: flex;
                justify-content: center;
                align-items: center;
                transition: background 0.3s;}

            .status-charging {
                background: #2ecc71;
                color: white;}

            .status-parked {
                background: #0c4cc4;
                color: white;}

            .battery-wrap { 
                display: flex; 
                align-items: center; 
                gap: 20px; 
                margin-top: 60px;}

            .adjust { 
                display: flex;
                justify-content: center;
                align-items: center;
                width: 60px; 
                height: 60px; 
                border-radius: 30px; 
                font-size: 30px; 
                border: none; 
                background: #555; 
                color: white; }
            
            .battery { 
                position: relative; 
                width: 200px; 
                height: 400px; 
                border: 6px solid #555; 
                border-radius: 20px; 
                box-sizing: border-box; } 

            .battery::after { 
                content: ""; 
                position: absolute; 
                top: -18px; 
                left: 50%; 
                transform: translateX(-50%); 
                width: 60px; 
                height: 12px; 
                background: #555; 
                border-radius: 6px; } 
            
            .level { 
                position: absolute; 
                bottom: 0; 
                width: 100%; 
                height: 50%; 
                border-radius: 14px; 
                transition: height 0.3s, background 0.3s; } 
            
            .soc-text { 
                position: absolute; 
                top: 50%; 
                left: 50%; 
                transform: translate(-50%, -50%); 
                font-size: 56px; 
                font-weight: 700; 
                z-index: 2; }
            
            .green-dark { background: #008040; } 
            .green-light { background: #2ecc71; } 
            .yellow { background: #f7ce2b; } 
            .orange { background: #fc841c; } 
            .red { background: #e74c3c; } 
            
            .loader {
                border: 6px solid #555;
                border-top: 6px solid #2ecc71;
                border-radius: 50%;
                width: 40px;
                height: 40px;
                animation: spin 0.8s linear infinite;
                display: none;
                margin-top: 20px;
            }

            .loader-overlay {
                position: absolute;
                top: 5%;
                left: 30%;
                transform: translate(-50%, -50%);
                width: 60px;
                height: 60px;
                border: 6px solid rgba(255,255,255,0.2);
                border-top: 6px solid #2ecc71;
                border-radius: 50%;
                animation: spin 0.8s linear infinite;
                display: none;
                z-index: 9999;
            }

            @keyframes spin {
                0% {transform: rotate(0deg);}
                100% {transform: rotate(360deg);}
            }

            .battery-row {
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 30px;
                width: 100%;}
                
        </style> 
    </head> 
            
    <body> 
    <div class="wrapper">

        <div class="app"> 

            <button id="startBtn" class="start-btn start">START</button>

        <div class="status-row">
            <button id="chargeBtn" class="status-btn">⚡️</button>
            <button id="settingsBtn" class="status-btn">⚙️</button>
            <button id="parkBtn" class="status-btn">P</button>
        </div>

        <div class="battery-row"> 

            <button id="minusBTN" class="adjust">−</button> 

                <div class="battery-wrap"> 
                    <div class="battery"> 
                        <div id="loader" class="loader-overlay"></div>
                        <div id="level" class="level"></div> 
                        <div id="socText" class="soc-text">50%</div> 
                    </div>
                </div> 
            
            <button id="plusBTN" class="adjust">+</button> 
        </div>
        </div>
    </div> 

<script type="module"> 

// Переменные

            const apikey = "APIKEY " + localStorage.getItem("apikey") || 0;
            const token = localStorage.getItem("token") || 0;
            let battKWT = Number(localStorage.getItem("battKWT")) || 0;
            let avgKWT100 = Number(localStorage.getItem("avgKWT100")) || 0;
            let KWTpower = Number(localStorage.getItem("KWTpower")) || 0;
            let energyKWT = 34.4;
            let avgKWT1 = avgKWT100 / 100;
            let tracking = false; 
            let charged = false;
            let parked = false;
            let posX = 0;
            let posY = 0;
            let posV = 0;
            let utctime = 0;
            let interval = null;

// Вычисляем SOC из энергии

            function getSOC() {
                return Math.round((energyKWT / battKWT) * 100);
            }

// Автозаряд и авторазряд

            function autoDischarge() {
                if (!tracking || charged) return;
                let KWTused = (posV * avgKWT1) * (2 / 3600);
                energyKWT = Math.max(0, energyKWT - KWTused);
                updateUI();
            }

            function autoCharge() {
                if (!charged) return;
                let KWTadded = KWTpower * (2 / 3600);
                energyKWT = Math.min(battKWT, energyKWT + KWTadded);
            }
// Цвет батареи

            function getBatteryColor(soc) { 
                if (soc > 80) return "green-dark"; 
                if (soc > 60) return "green-light"; 
                if (soc > 40) return "yellow"; 
                if (soc > 20) return "orange"; 
                return "red"; 
            } 

// Обновление UI

            function updateUI() {
                const soc = getSOC(); 
                document.getElementById("socText").innerText = soc + "%"; 
            
                let level = document.getElementById("level"); 
                    level.style.height = soc + "%"; 
                    level.className = "level " + getBatteryColor(soc); 

                let btn = document.getElementById("startBtn"); 
                    btn.innerText = tracking ? "STOP" : "START"; 
                    btn.className = tracking ? "start-btn stop" : "start-btn start";
            } 

// Кнопки

            document.getElementById("settingsBtn").onclick = () => {
                location.assign("settings.html");
            }
            
            document.getElementById("minusBTN").addEventListener("click", () => changeSOC(-1));
            document.getElementById("plusBTN").addEventListener("click", () => changeSOC(+1));

            function changeSOC(deltaParcent) {
                let deltaKWT = battKWT * (deltaParcent / 100);
                energyKWT = Math.max(0, Math.min(battKWT, energyKWT + deltaKWT)); 
                updateUI();
            } 
            document.getElementById("chargeBtn").onclick = () => {
                charged = !charged;
                updateStatusButtons();
            };
            document.getElementById("startBtn").onclick = () => { 
                tracking = !tracking; 
                updateUI(); 

                if (tracking){
                    interval = setInterval(() => {
                        autoDischarge();
                        autoCharge();
                        sendTelemetry();
                        updateUI();
                    }, 2000);
                } else {
                    clearInterval(interval);
                    document.getElementById("loader").style.display = "none";
                }
            }

// Статус парковки

            function updateParkingStatus() {
                parked = (posV < 1);
            }

            function updateStatusButtons() {
                const chargeBtn = document.getElementById("chargeBtn");
                const parkBtn = document.getElementById("parkBtn");

            if (charged) {
                chargeBtn.classList.add("status-charging");
                } else {
                chargeBtn.classList.remove("status-charging");
                }

            if (parked) {
                parkBtn.classList.add("status-parked");
                } else {
                parkBtn.classList.remove("status-parked");
                }
            }

// Координаты

            navigator.geolocation.watchPosition(pos => {
                posX = pos.coords.latitude;
                posY = pos.coords.longitude;
                posV = pos.coords.speed ?? 0;
                if (posV < 0) posV = 0;

                updateParkingStatus();
                updateStatusButtons();

                utctime = Math.floor(Date.now() / 1000);
            },
            err => console.log("GPS ERROR", err),
            {
                enableHighAccuracy: true,
                maximumAge: 0,
                timeout: 5000
            });

// Отправка телеметрии

            async function sendTelemetry() {
                if (!tracking) return;
        
            const loader = document.getElementById("loader");
            loader.style.display = "block";

            let body = {
                token: token,
                tlm: {
                    utc: utctime,
                    soc: getSOC(),
                    power: 0,
                    speed: posV,
                    lat: posX,
                    lon: posY,
                    is_charging: charged,
                    is_parked: parked
                }
            };

            try {    
                let res = await fetch("https://api.iternio.com/1/tlm/send", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": apikey
                    },
                    body: JSON.stringify(body)
                    });

                console.log(await res.json());
            } catch (err) {
                console.log("ERROR", err); 
            } finally {
                loader.style.display = "none";
            }
            }

// Обновление настроек

            function reloadSettings() {
                battKWT = Number(localStorage.getItem("battKWT")) || 0;
                avgKWT100 = Number(localStorage.getItem("avgKWT100")) || 0;
                KWTpower = Number(localStorage.getItem("KWTpower")) || 0;
                avgKWT1 = avgKWT100 / 100;

                updateUI();

                if (tracking) {
                    clearInterval(interval);
                    interval = setInterval(() => {
                        autoDischarge();
                        autoCharge();
                        sendTelemetry();
                        updateUI();
                    }, 2000);
                }

            }

            reloadSettings();
            window.addEventListener("focus", reloadSettings);

            updateStatusButtons();
            updateUI();
</script> 

    </body> 

</html>